<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç²¾ç¾æ¨ç®±å­ - ç½‘é¡µç‰ˆ</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --board-bg: #e0e5ec;
            --wall-color: #5e6c7c;
            --floor-color: #ffffff;
            --target-color: #ff7675;
            --box-color: #fdcb6e;
            --box-on-target: #00b894;
            --player-color: #0984e3;
            --text-color: #2d3436;
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        header {
            text-align: center;
            margin-bottom: 10px;
        }

        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 2px; }
        .status { font-size: 0.9rem; margin-top: 5px; color: #636e72; }

        /* æ¸¸æˆåŒºåŸŸ */
        #game-container {
            position: relative;
            background: #fff;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        #game-board {
            display: grid;
            background-color: var(--board-bg);
            border-radius: 8px;
            overflow: hidden;
        }

        .cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.1s ease;
        }

        /* å“åº”å¼æ ¼å­å¤§å° */
        @media (max-width: 500px) {
            .cell { width: 9vmin; height: 9vmin; font-size: 5vmin; }
        }

        /* å…ƒç´ æ ·å¼ */
        .wall { background-color: var(--wall-color); box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        .floor { background-color: var(--floor-color); }
        .target { position: relative; }
        .target::after {
            content: '';
            position: absolute;
            width: 30%;
            height: 30%;
            background-color: var(--target-color);
            border-radius: 50%;
        }
        
        .box {
            background-color: var(--box-color);
            border-radius: 4px;
            border: 2px solid #dfa536;
            width: 80%;
            height: 80%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .box.ok {
            background-color: var(--box-on-target);
            border-color: #008f72;
        }

        .player {
            width: 80%;
            height: 80%;
            background-color: var(--player-color);
            border-radius: 50%;
            border: 2px solid #065fa3;
            z-index: 20;
            position: relative;
        }
        /* ç»™ç©å®¶åŠ ä¸ªç®€å•çš„ç¬‘è„¸ */
        .player::before, .player::after {
            content: ''; position: absolute; top: 30%; width: 15%; height: 15%; background: white; border-radius: 50%;
        }
        .player::before { left: 25%; } .player::after { right: 25%; }

        /* æ§åˆ¶åŒºåŸŸ */
        #controls {
            margin-top: 20px;
            display: grid;
            grid-template-areas: 
                ". up ."
                "left down right";
            gap: 10px;
        }

        .btn {
            width: 60px;
            height: 60px;
            background: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s, background 0.2s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active { transform: scale(0.9); background: #f1f1f1; }
        
        #btn-up { grid-area: up; }
        #btn-down { grid-area: down; }
        #btn-left { grid-area: left; }
        #btn-right { grid-area: right; }

        .action-btns {
            margin-top: 15px;
            display: flex;
            gap: 20px;
        }

        .text-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ccc;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }

        /* èƒœåˆ©å¼¹çª— */
        #win-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #win-modal.show { visibility: visible; opacity: 1; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); } to { transform: scale(1); } }
        .modal-content h2 { color: var(--box-on-target); margin-top: 0; }
        .next-btn {
            background: var(--player-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1rem;
            margin-top: 15px;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <header>
        <h1>æ¨ç®±å­ SOKOBAN</h1>
        <div class="status">ç¬¬ <span id="level-num">1</span> å…³ | æ­¥æ•°: <span id="step-count">0</span></div>
    </header>

    <div id="game-container">
        <div id="game-board"></div>
    </div>

    <div id="controls">
        <button class="btn" id="btn-up">â–²</button>
        <button class="btn" id="btn-left">â—€</button>
        <button class="btn" id="btn-down">â–¼</button>
        <button class="btn" id="btn-right">â–¶</button>
    </div>

    <div class="action-btns">
        <button class="text-btn" onclick="game.resetLevel()">â†º é‡ç½®æœ¬å…³</button>
        </div>

    <div id="win-modal">
        <div class="modal-content">
            <h2>ğŸ‰ æ­å–œè¿‡å…³!</h2>
            <p>ä½ å®Œæˆäº†æœ¬å…³æŒ‘æˆ˜ã€‚</p>
            <button class="next-btn" onclick="game.nextLevel()">ä¸‹ä¸€å…³</button>
        </div>
    </div>

    <script>
        
        const levels = [
            // === ç¬¬1-5å…³ï¼šæ–°æ‰‹å…¥é—¨ (æ•™å­¦å…³) ===
            // ç¬¬1å…³ï¼šåˆæ¬¡è§é¢ (ç›´çº¿æ¨)
            [
                "#####",
                "#@  #",
                "# $ #",
                "#  !#",
                "#####"
            ],
            // ç¬¬2å…³ï¼šç®€å•è½¬å¼¯ (å­¦ä¼šä¸è¦æ¨åˆ°æ­»è§’)
            [
                "  #####",
                "###   #",
                "# ! $ #",
                "#  @  #",
                "#######"
            ],
            // ç¬¬3å…³ï¼šåŒç®±å­ (ç®€å•çš„é¡ºåºåˆ¤æ–­)
            [
                "######",
                "#    #",
                "# $! #",
                "# @$!#",
                "#    #",
                "######"
            ],
            // ç¬¬4å…³ï¼šåˆ†ç¦»ç›®æ ‡ (å­¦ä¼šåˆ†å¤´è¡ŒåŠ¨)
            [
                "#######",
                "#     #",
                "#  $  #",
                "##!@!##",
                "#  $  #",
                "#     #",
                "#######"
            ],
            // ç¬¬5å…³ï¼šTå­—è·¯å£ (ç©ºé—´åˆ©ç”¨)
            [
                "  #### ",
                "###  # ",
                "# !@$# ",
                "# $   #",
                "# !   #",
                "#######"
            ],

            // === ç¬¬6-10å…³ï¼šåˆçº§æŒ‘æˆ˜ (å¼€å§‹éœ€è¦æ€è€ƒ) ===
            // ç¬¬6å…³ï¼šå°ä»“åº“ (ç»å…¸çš„3ç®±å­å¸ƒå±€)
            [
                "  ####  ",
                "###  ###",
                "#      #",
                "# !$$! #",
                "##  @###",
                " # $!#  ",
                "  ####  "
            ],
            // ç¬¬7å…³ï¼šèµ°å»Š (ç‹­çª„é€šé“çš„å¤„ç†)
            [
                "######  ",
                "# !  ###",
                "# $  @ #",
                "# $ ####",
                "###!#   ",
                "  ###   "
            ],
            // ç¬¬8å…³ï¼šå›æ—‹é•– (éœ€è¦ç»•è·¯)
            [
                "#######",
                "#  !  #",
                "# $#$ #",
                "# !@! #",
                "# $#$ #",
                "#  !  #",
                "#######"
            ],
            // ç¬¬9å…³ï¼šå››æ–¹é˜µ (å®¹æ˜“æŠŠè‡ªå·±å µæ­»)
            [
                "#########",
                "#   !   #",
                "# $ # $ #",
                "## ### ##",
                "#   @   #",
                "## ###  #",
                "#   !   #",
                "#########"
            ],
            // ç¬¬10å…³ï¼šç»å…¸å¾®ç¼© (çœ‹ä¼¼ç®€å•ï¼Œæ­¥æ­¥æƒŠå¿ƒ)
            [
                "  ##### ",
                "###   # ",
                "# ! $ # ",
                "#  #$ # ",
                "### ! # ",
                "  # @ # ",
                "  ##### "
            ],

            // === ç¬¬11-15å…³ï¼šä¸­çº§æŒ‘æˆ˜ (é€»è¾‘è¿›é˜¶) ===
            // ç¬¬11å…³ï¼šUå‹é™·é˜±
            [
                "  #######",
                "  #  !! #",
                "### $#$ #",
                "#  $@$  #",
                "#  !#!  #",
                "#       #",
                "#########"
            ],
            // ç¬¬12å…³ï¼šé”™ä½å¯¹é½
            [
                "#######",
                "#     #",
                "# $!$ #",
                "##$@$##",
                "# ! ! #",
                "#  !  #",
                "#######"
            ],
            // ç¬¬13å…³ï¼šä¸è¦è¿›æˆ¿é—´ (é—¨å‰æ¸…ç†)
            [
                "#######",
                "#  !  #",
                "# $#$ #",
                "# !$! #",
                "## @ ##",
                " #   # ",
                " ##### "
            ],
            // ç¬¬14å…³ï¼šHå‹ç»“æ„
            [
                " ####### ",
                " #  !  # ",
                "## $#$ ##",
                "#  !@!  #",
                "## $#$ ##",
                " #  !  # ",
                " ####### "
            ],
            // ç¬¬15å…³ï¼šè‘—åçš„ Microban æ”¹ç‰ˆ
            [
                "########",
                "#      #",
                "# !  ! #",
                "#  $$  #",
                "## @  ##",
                " # $$ # ",
                " #!  !# ",
                " ###### "
            ],

            // === ç¬¬16-20å…³ï¼šé«˜çº§æŒ‘æˆ˜ (çƒ§è„‘æ—¶åˆ») ===
            // ç¬¬16å…³ï¼šä¸‰é‡é—¨
            [
                "   #####",
                "####   #",
                "#   $@ #",
                "#   $ ##",
                "##$##  #",
                "# ! !  #",
                "#  !   #",
                "####### "
            ],
            // ç¬¬17å…³ï¼šèºæ—‹è¿·å®«
            [
                "########",
                "#  ! ! #",
                "#  $ $  #",
                "###   ###",
                "#  $ $  #",
                "# @! !  #",
                "########"
            ],
            // ç¬¬18å…³ï¼šæ‹¥æŒ¤çš„æˆ¿é—´ (ç¨å¾®åŠ¨é”™ä¸€æ­¥å°±æ­»)
            [
                "  ######",
                "###    #",
                "#   $# #",
                "# $  $ #",
                "## !# @#",
                " # !!###",
                "  ####  "
            ],
            // ç¬¬19å…³ï¼šå¯¹ç§°çš„è°è¨€ (è§£æ³•ä¸å¯¹ç§°)
            [
                "#########",
                "#!  !  !#",
                "# $ $ $ #",
                "# # @ # #",
                "# $ $ $ #",
                "#!  !  !#",
                "#########"
            ],
            // ç¬¬20å…³ï¼šæœ€ç»ˆè¯•ç‚¼ (ç»¼åˆèƒ½åŠ›)
            [
                "  ######  ",
                "  #!   #  ",
                "### #$ ## ",
                "#   $  !# ",
                "# ! #$! # ",
                "##  @  ## ",
                " # $#$ #  ",
                " #  !  #  ",
                " #######  "
            ]
        ];

        class Sokoban {
            constructor() {
                this.currentLevel = 19;
                this.steps = 0;
                this.map = []; // å½“å‰åœ°å›¾çŠ¶æ€
                this.playerPos = {x: 0, y: 0};
                this.boardEl = document.getElementById('game-board');
                this.stepEl = document.getElementById('step-count');
                this.levelEl = document.getElementById('level-num');
                this.modal = document.getElementById('win-modal');
                
                this.init();
            }

            init() {
                this.loadLevel(this.currentLevel);
                this.setupInputs();
            }

            // è§£æå…³å¡å¹¶æ¸²æŸ“
            loadLevel(levelIndex) {
                if (levelIndex >= levels.length) {
                    alert("æ­å–œï¼ä½ é€šå…³äº†æ‰€æœ‰å…³å¡ï¼");
                    this.currentLevel = 0;
                }
                
                // æ·±æ‹·è´åœ°å›¾æ•°æ®ï¼Œé˜²æ­¢ä¿®æ”¹åŸå§‹æ•°æ®
                const rawMap = levels[this.currentLevel];
                this.map = rawMap.map(row => row.split(''));
                
                // æ‰¾å‡ºæœ€é•¿çš„ä¸€è¡Œï¼Œç”¨äºè®¾ç½®Gridåˆ—æ•°
                let maxCol = 0;
                this.map.forEach(row => maxCol = Math.max(maxCol, row.length));

                // è¡¥é½çŸ­è¡Œï¼ˆç”¨ç©ºæ ¼å¡«å……ï¼‰ï¼Œé¿å…æ•°ç»„è¶Šç•Œé£é™©
                for(let y=0; y<this.map.length; y++) {
                    while(this.map[y].length < maxCol) {
                        this.map[y].push(' ');
                    }
                    // æŸ¥æ‰¾ç©å®¶åˆå§‹ä½ç½®
                    for(let x=0; x<maxCol; x++) {
                        if (this.map[y][x] === '@' || this.map[y][x] === '+') {
                            this.playerPos = {x, y};
                        }
                    }
                }

                this.steps = 0;
                this.updateUI();
                this.render();
                this.modal.classList.remove('show');
            }

            // æ¸²æŸ“ç½‘æ ¼
            render() {
                this.boardEl.innerHTML = '';
                const rows = this.map.length;
                const cols = this.map[0].length;

                // è®¾ç½®CSS Grid
                this.boardEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                this.boardEl.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < cols; x++) {
                        const cellType = this.map[y][x];
                        const cellDiv = document.createElement('div');
                        cellDiv.className = 'cell';
                        
                        // åŸºç¡€å›¾å±‚
                        const floorDiv = document.createElement('div');
                        floorDiv.className = 'floor'; 
                        
                        // æ ¹æ®å­—ç¬¦åˆ¤å®šç±»å‹
                        if (cellType === '#') {
                            cellDiv.classList.add('wall');
                        } else {
                            cellDiv.classList.add('floor'); // åœ°æ¿èƒŒæ™¯
                            
                            if (cellType === '!' || cellType === '*' || cellType === '+') {
                                cellDiv.classList.add('target'); // ç›®æ ‡ç‚¹æ ‡è®°
                            }

                            if (cellType === '$') {
                                const box = document.createElement('div');
                                box.className = 'box';
                                cellDiv.appendChild(box);
                            } else if (cellType === '*') {
                                const box = document.createElement('div');
                                box.className = 'box ok';
                                cellDiv.appendChild(box);
                            } else if (cellType === '@' || cellType === '+') {
                                const player = document.createElement('div');
                                player.className = 'player';
                                cellDiv.appendChild(player);
                            }
                        }
                        this.boardEl.appendChild(cellDiv);
                    }
                }
            }

            // ç§»åŠ¨é€»è¾‘
            move(dx, dy) {
                const x = this.playerPos.x;
                const y = this.playerPos.y;
                const newX = x + dx;
                const newY = y + dy;

                // è¾¹ç•Œæ£€æŸ¥ï¼ˆç†è®ºä¸Šå¢™å£åŒ…è£¹ä¸ä¼šè¶Šç•Œï¼Œä½†ä¸ºäº†å®‰å…¨ï¼‰
                if (this.isOutOfBounds(newX, newY)) return;

                const targetCell = this.map[newY][newX];

                // 1. å¦‚æœå‰æ–¹æ˜¯å¢™ï¼Œä¸èƒ½ç§»åŠ¨
                if (targetCell === '#') return;

                // 2. å¦‚æœå‰æ–¹æ˜¯ç®±å­ ($ æˆ– *)
                if (targetCell === '$' || targetCell === '*') {
                    const boxNewX = newX + dx;
                    const boxNewY = newY + dy;

                    // æ£€æŸ¥ç®±å­åæ–¹æ˜¯å¦æœ‰éšœç¢
                    if (this.isOutOfBounds(boxNewX, boxNewY)) return;
                    const boxTargetCell = this.map[boxNewY][boxNewX];

                    // ç®±å­åé¢å¦‚æœæ˜¯å¢™æˆ–å¦ä¸€ä¸ªç®±å­ï¼Œæ¨ä¸åŠ¨
                    if (boxTargetCell === '#' || boxTargetCell === '$' || boxTargetCell === '*') {
                        return;
                    }

                    // ç§»åŠ¨ç®±å­
                    // æ›´æ–°ç®±å­æ–°ä½ç½®çŠ¶æ€
                    if (boxTargetCell === '!') this.map[boxNewY][boxNewX] = '*';
                    else this.map[boxNewY][boxNewX] = '$';

                    // æ›´æ–°ç®±å­åŸä½ç½®ï¼ˆå³äººå°†è¦å»çš„ä½ç½®ï¼‰çŠ¶æ€ï¼ˆæš‚æ—¶æ¸…é™¤ç®±å­ï¼Œç¨åäººä¼šè¿‡å»ï¼‰
                    if (targetCell === '*') this.map[newY][newX] = '!'; // ç®±å­åŸæ¥åœ¨ç›®æ ‡ç‚¹
                    else this.map[newY][newX] = ' '; // ç®±å­åŸæ¥åœ¨æ™®é€šåœ°
                }

                // 3. ç§»åŠ¨ç©å®¶
                // æ›´æ–°ç©å®¶æ—§ä½ç½®
                const currentCell = this.map[y][x];
                if (currentCell === '+') this.map[y][x] = '!'; // ç¦»å¼€ç›®æ ‡ç‚¹
                else this.map[y][x] = ' '; // ç¦»å¼€æ™®é€šåœ°

                // æ›´æ–°ç©å®¶æ–°ä½ç½®
                // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦é‡æ–°è·å–newX, newYçš„å†…å®¹ï¼Œå› ä¸ºå¦‚æœæ˜¯æ¨ç®±å­ï¼Œä¸Šé¢å·²ç»ä¿®æ”¹è¿‡è¯¥ä½ç½®çš„çŠ¶æ€äº†
                const nextSpot = this.map[newY][newX]; 
                if (nextSpot === '!' || nextSpot === '*') { 
                    // è¿™é‡Œæœ‰ä¸ªé€»è¾‘ç»†èŠ‚ï¼šå¦‚æœæ¨ç®±å­ï¼Œç®±å­å·²ç»ç§»èµ°äº†ï¼Œè¿™é‡Œåªå¯èƒ½æ˜¯'!'æˆ–è€…' 'ã€‚
                    // ä½†å¦‚æœå‰æ–¹æœ¬æ¥å°±æ˜¯ç©ºçš„ç›®æ ‡ç‚¹ '!'
                   this.map[newY][newX] = '+';
                } else {
                   this.map[newY][newX] = '@';
                }

                this.playerPos = {x: newX, y: newY};
                this.steps++;
                this.updateUI();
                this.render();
                this.checkWin();
            }

            isOutOfBounds(x, y) {
                return y < 0 || y >= this.map.length || x < 0 || x >= this.map[0].length;
            }

            checkWin() {
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç®±å­éƒ½åœ¨ç›®æ ‡ç‚¹
                // åªè¦åœ°å›¾é‡Œè¿˜æœ‰æ™®é€šç®±å­ '$'ï¼Œå°±æ²¡èµ¢
                // å¦‚æœå…¨æ˜¯åˆ°ä½ç®±å­ '*'ï¼Œåˆ™èƒœåˆ©
                let hasUnfinishedBox = false;
                for(let row of this.map) {
                    if (row.includes('$')) {
                        hasUnfinishedBox = true;
                        break;
                    }
                }

                if (!hasUnfinishedBox) {
                    setTimeout(() => {
                        this.modal.classList.add('show');
                    }, 200);
                }
            }

            nextLevel() {
                this.currentLevel++;
                this.loadLevel(this.currentLevel);
            }

            resetLevel() {
                if(confirm("ç¡®å®šè¦é‡ç½®æœ¬å…³å—ï¼Ÿ")) {
                    this.loadLevel(this.currentLevel);
                }
            }

            updateUI() {
                this.stepEl.innerText = this.steps;
                this.levelEl.innerText = this.currentLevel + 1;
            }

            setupInputs() {
                // é”®ç›˜ç›‘å¬
                document.addEventListener('keydown', (e) => {
                    switch(e.key) {
                        case 'ArrowUp': case 'w': this.move(0, -1); break;
                        case 'ArrowDown': case 's': this.move(0, 1); break;
                        case 'ArrowLeft': case 'a': this.move(-1, 0); break;
                        case 'ArrowRight': case 'd': this.move(1, 0); break;
                    }
                });

                // è§¦æ‘¸æŒ‰é’®ç›‘å¬
                const bindBtn = (id, dx, dy) => {
                    const btn = document.getElementById(id);
                    // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆæ¯”å¦‚åŒå‡»ç¼©æ”¾ï¼‰
                    btn.addEventListener('touchstart', (e) => { e.preventDefault(); this.move(dx, dy); });
                    btn.addEventListener('click', () => this.move(dx, dy));
                };

                bindBtn('btn-up', 0, -1);
                bindBtn('btn-down', 0, 1);
                bindBtn('btn-left', -1, 0);
                bindBtn('btn-right', 1, 0);
            }
        }

        // å¯åŠ¨æ¸¸æˆ
        const game = new Sokoban();

    </script>
</body>
</html>
