<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è´ªåƒè›‡ - å®Œç¾ä¿®å¤ç‰ˆ</title>
    <style>
        :root {
            /* æ–°é…è‰²ï¼šæ·±è‰²ä¸»é¢˜ + æ¸…æ–°ç»¿è‰²è›‡èº« + æ¸©æš–å¼ºè°ƒè‰² */
            --bg-color: #071226;        /* æ·±å¤œè“èƒŒæ™¯ */
            --header-bg: #071a2b;      /* é¡¶æ  */
            --game-bg: #082233;        /* æ¸¸æˆåŒºåŸŸèƒŒæ™¯ */
            --grid-color: rgba(255,255,255,0.04);
            --border-color: rgba(255,255,255,0.06);
            --panel-bg: rgba(2,6,23,0.5);
            --snake-head: #7ee787;     /* äº®ç»¿å¤´ */
            --snake-body: #49d08f;     /* ç»¿èº« */
            --btn-bg: rgba(255, 255, 255, 0.06);
            --btn-active: rgba(255, 255, 255, 0.12);
            --text-color: #e6f0ff;
            --muted: #9fb0c8;
            --accent: #ffd166;         /* æš–è‰²å¼ºè°ƒ */
        }

        * {
            box-sizing: border-box;
            touch-action: none; /* ç¦æ­¢ç¼©æ”¾å’Œæ»šåŠ¨ */
            user-select: none;  /* ç¦æ­¢é€‰ä¸­æ–‡æœ¬ */
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: sans-serif;
            height: 100vh; /* å æ»¡å…¨å± */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 1. é¡¶éƒ¨æ  (é«˜åº¦å›ºå®š 50px) */
        header {
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        h1 { font-size: 18px; margin: 0; color: var(--accent); }
        .score { font-size: 18px; font-weight: bold; }

        /* 2. æ¸¸æˆä¸»åŒºåŸŸ (è‡ªåŠ¨å æ»¡å‰©ä½™ç©ºé—´) */
        #game-container {
            flex: none; /* å›ºå®šé«˜åº¦ï¼Œä¾¿äºç¼©å°æ¸¸æˆåŒºåŸŸ */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            overflow: hidden;
            width: 100%;
            /* å°†æ¸¸æˆåŒºåŸŸé™åˆ¶ä¸ºä¸€ä¸ªåˆé€‚é«˜åº¦ï¼ˆå‡å» header ä¸æ§åˆ¶åŒºï¼‰ï¼Œå¹¶åœ¨å°å±å¹•ä¸Šè‡ªé€‚åº” */
            height: calc(100vh - 50px - 120px);
            max-height: 72vh;
            margin: 10px auto;
            border-radius: 8px;
        }

        canvas {
            background-color: var(--game-bg);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            /* ä¿æŒåƒç´ æ¸…æ™° */
            image-rendering: pixelated; 
        }

        /* UI å¼¹çª— */
        #ui-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .hidden { display: none !important; }
        
        .menu-title { font-size: 24px; margin-bottom: 20px; color: var(--accent); }
        .menu-btn {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 12px 30px;
            margin: 8px;
            border-radius: 8px;
            font-size: 16px;
            width: 200px;
            cursor: pointer;
        }
        .menu-btn:active { transform: scale(0.96); }
        .bg-green { background: #15803d; }
        .bg-blue { background: #1d4ed8; }
        .bg-red { background: #b91c1c; }

        /* 3. åº•éƒ¨æ§åˆ¶åŒº (é«˜åº¦å›ºå®š 140px) */
        /* å°†æ§åˆ¶åŒºæ”¹ä¸ºæ‚¬æµ®åœ¨åº•éƒ¨çš„å›ºå®šé¢æ¿ï¼Œå‘ä¸Šç§»åŠ¨ä»¥ä¾¿æ›´å®¹æ˜“è§¦è¾¾ */
        #controls {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 14px; /* ä¸Šç§»æŒ‰é”®ï¼Œä¾¿äºæ‹‡æŒ‡è§¦è¾¾ */
            height: auto;
            background: transparent;
            border-top: none;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 30;
            pointer-events: none; /* é»˜è®¤ä¸ºä¸å¯äº¤äº’ï¼Œå†…éƒ¨ .d-pad ä¼šæ‰“å¼€äº¤äº’ */
            width: 100%;
            max-width: 420px;
            padding: 4px;
        }

        /* åå­—é”®å¸ƒå±€ä¼˜åŒ– */
        .d-pad {
            display: grid;
            grid-template-columns: 56px 56px 56px;
            grid-template-rows: 48px 48px;
            gap: 8px;
            background: rgba(0,0,0,0.18);
            padding: 8px;
            border-radius: 12px;
            pointer-events: auto; /* å¼€å¯äº¤äº’ */
            box-shadow: 0 6px 20px rgba(2,6,23,0.6);
        }
        
        .key {
            background: var(--btn-bg);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: rgba(255,255,255,0.95);
            cursor: pointer;
            width: 56px;
            height: 48px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        .key:active { background: var(--btn-active); }
        
        .k-up { grid-column: 2; grid-row: 1; }
        .k-left { grid-column: 1; grid-row: 2; }
        .k-down { grid-column: 2; grid-row: 2; }
        .k-right { grid-column: 3; grid-row: 2; }

    </style>
</head>
<body>

    <header>
        <h1>ğŸ è´ªåƒè›‡é‡åˆ¶ç‰ˆ</h1>
        <div class="score">å¾—åˆ†: <span id="score-val">0</span></div>
    </header>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div id="ui-overlay">
            <div id="start-menu">
                <div class="menu-title">é€‰æ‹©éš¾åº¦</div>
                <button class="menu-btn bg-green" onclick="initGame('easy')">ç®€å• (æ…¢)</button>
                <button class="menu-btn bg-blue" onclick="initGame('normal')">æ™®é€š (ä¸­)</button>
                <button class="menu-btn bg-red" onclick="initGame('hard')">å›°éš¾ (å¿«)</button>
            </div>
            
            <div id="game-over-menu" class="hidden">
                <div class="menu-title">æ¸¸æˆç»“æŸ</div>
                <p id="fail-reason" style="color: var(--muted); margin-bottom: 20px;">æ’å¢™äº†</p>
                <button class="menu-btn bg-blue" onclick="showStartMenu()">è¿”å›ä¸»èœå•</button>
            </div>
        </div>
    </div>

    <div id="controls">
        <div class="d-pad">
            <div class="key k-up" data-dir="up">â–²</div>
            <div class="key k-left" data-dir="left">â—€</div>
            <div class="key k-down" data-dir="down">â–¼</div>
            <div class="key k-right" data-dir="right">â–¶</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score-val');
        const uiOverlay = document.getElementById('ui-overlay');
        const startMenu = document.getElementById('start-menu');
        const gameOverMenu = document.getElementById('game-over-menu');
        const failReasonEl = document.getElementById('fail-reason');
        const gameContainer = document.getElementById('game-container');

        // è¯»å– CSS å˜é‡ï¼Œä¾›ç”»å¸ƒç»˜åˆ¶ä½¿ç”¨ï¼ˆä½¿ JS ä¸ä¸»é¢˜è”åŠ¨ï¼‰
        const __cssVars = getComputedStyle(document.documentElement);
        const COLOR_GAME_BG = __cssVars.getPropertyValue('--game-bg').trim() || '#1e293b';
        const COLOR_GRID = __cssVars.getPropertyValue('--grid-color').trim() || '#334155';
        const COLOR_SNAKE_HEAD = __cssVars.getPropertyValue('--snake-head').trim() || '#22c55e';
        const COLOR_SNAKE_BODY = __cssVars.getPropertyValue('--snake-body').trim() || '#4ade80';
        const COLOR_MUTED = __cssVars.getPropertyValue('--muted').trim() || '#475569';

        // --- é…ç½® ---
        let GRID_SIZE = 20; // é»˜è®¤ç½‘æ ¼å¤§å°
        let COLS = 20;
        let ROWS = 20;
        
        // æ¸¸æˆå˜é‡
        let snake = [];
        let food = {};
        let bombs = [];
        let dx = 1; // é»˜è®¤å‘å³ (æ¨ªå±å‹å¥½)
        let dy = 0;
        let nextDx = 1;
        let nextDy = 0;
        let score = 0;
        let gameLoop = null;
        let isRunning = false;
        let currentSpeed = 150;

        const FOODS = ['ğŸ','ğŸŠ','ğŸ‡','ğŸ‰','ğŸŒ','ğŸ','ğŸ“','ğŸ’','ğŸ‘','ğŸ”','ğŸ•','ğŸ—'];

        // --- æ ¸å¿ƒï¼šå®Œç¾é€‚é…å±å¹• ---
        function resizeCanvas() {
            // è·å–å®¹å™¨çš„å®é™…å®½é«˜
            const containerW = gameContainer.clientWidth;
            const containerH = gameContainer.clientHeight;

            // ç•™ä¸€ç‚¹è¾¹è·ï¼Œç¾è§‚
            const maxW = containerW - 4; 
            const maxH = containerH - 4;

            // åŠ¨æ€è°ƒæ•´ç½‘æ ¼å¤§å°ï¼šå¦‚æœå±å¹•å¤ªå°ï¼Œç¼©å°ç½‘æ ¼ä»¥ä¿è¯æœ‰è¶³å¤Ÿæ­¥æ•°
            // ç¡®ä¿è‡³å°‘æœ‰ 15x15 çš„æ ¼å­ï¼Œå¦åˆ™æ¸¸æˆå¾ˆéš¾ç©
            GRID_SIZE = Math.floor(Math.min(maxW / 15, maxH / 15, 25)); // æœ€å¤§25pxï¼Œæœ€å°åŠ¨æ€ç®—
            
            // è®¡ç®—è¡Œåˆ—
            COLS = Math.floor(maxW / GRID_SIZE);
            ROWS = Math.floor(maxH / GRID_SIZE);

            canvas.width = COLS * GRID_SIZE;
            canvas.height = ROWS * GRID_SIZE;

            // å¦‚æœ canvas çš„åƒç´ å°ºå¯¸è¿‡å¤§ï¼Œé™åˆ¶å…¶ CSS æ˜¾ç¤ºå¤§å°ä»¥ä¿æŒåœ¨å®¹å™¨å†…
            canvas.style.maxWidth = Math.min(canvas.width, 760) + 'px';
            canvas.style.width = '100%';
            canvas.style.height = 'auto';

            // å¦‚æœæ¸¸æˆæœªè¿›è¡Œï¼Œé‡ç»˜èƒŒæ™¯
            if (!isRunning) drawStatic();
        }

        // ç›‘å¬çª—å£å˜åŒ–ï¼Œä½†ä¸ºäº†é˜²æ­¢æ‰‹æœºé”®ç›˜å¼¹å‡ºå¯¼è‡´çš„æŠ–åŠ¨ï¼Œåªåœ¨éè¿è¡ŒçŠ¶æ€å¼ºåˆ¶é‡ç®—
        window.addEventListener('resize', () => {
            if(!isRunning) resizeCanvas();
        });
        
        // åˆå§‹åŒ–è°ƒç”¨ä¸€æ¬¡
        resizeCanvas();

        // --- æ¸¸æˆæµç¨‹ ---

        function showStartMenu() {
            uiOverlay.classList.remove('hidden');
            startMenu.classList.remove('hidden');
            gameOverMenu.classList.add('hidden');
            resizeCanvas(); // ç¡®ä¿å›åˆ°èœå•æ—¶å°ºå¯¸æ­£ç¡®
        }

        function initGame(difficulty) {
            // 1. å¼ºåˆ¶é‡æ–°è®¡ç®—å°ºå¯¸ï¼ˆé˜²æ­¢ä¹‹å‰å°ºå¯¸ä¸å¯¹ï¼‰
            resizeCanvas();

            // 2. è®¾ç½®é€Ÿåº¦
            if (difficulty === 'easy') currentSpeed = 400;
            if (difficulty === 'normal') currentSpeed = 240;
            if (difficulty === 'hard') currentSpeed = 140;

            // 3. åˆå§‹åŒ–çŠ¶æ€
            snake = [
                {x: 3, y: Math.floor(ROWS/2)}, 
                {x: 2, y: Math.floor(ROWS/2)}, 
                {x: 1, y: Math.floor(ROWS/2)}
            ];
            dx = 1; dy = 0; // åˆå§‹å‘å³
            nextDx = 1; nextDy = 0;
            score = 0;
            scoreEl.innerText = "0";
            bombs = [];
            
            // 4. UI åˆ‡æ¢
            uiOverlay.classList.add('hidden');
            isRunning = true;
            
            spawnFood();
            
            if (gameLoop) clearInterval(gameLoop);
            gameLoop = setInterval(update, currentSpeed);
            // å¯åŠ¨ç‹¬ç«‹çš„æ¸²æŸ“å¾ªç¯ï¼Œç¡®ä¿æ¸²æŸ“ä¸ speedï¼ˆç§»åŠ¨é—´éš”ï¼‰è§£è€¦
            startRender();
        }

        function gameOver(reason) {
            isRunning = false;
            clearInterval(gameLoop);
            failReasonEl.innerText = reason;
            uiOverlay.classList.remove('hidden');
            startMenu.classList.add('hidden');
            gameOverMenu.classList.remove('hidden');
        }

        // --- é€»è¾‘ ---

        function spawnFood() {
            let valid = false;
            while (!valid) {
                const fx = Math.floor(Math.random() * COLS);
                const fy = Math.floor(Math.random() * ROWS);
                if (!checkCollision(fx, fy)) {
                    food = {
                        x: fx, y: fy,
                        icon: FOODS[Math.floor(Math.random() * FOODS.length)]
                    };
                    valid = true;
                }
            }
            // 20% æ¦‚ç‡ç”Ÿæˆç‚¸å¼¹ï¼Œæœ€å¤š5ä¸ª
            if (bombs.length < 5 && Math.random() < 0.2 && score > 0) {
                spawnBomb();
            }
        }

        function spawnBomb() {
            let valid = false;
            let safety = 0;
            while (!valid && safety < 10) {
                const bx = Math.floor(Math.random() * COLS);
                const by = Math.floor(Math.random() * ROWS);
                
                // è·ç¦»è›‡å¤´å¤ªè¿‘ä¸ç”Ÿæˆ (3æ ¼ä¿æŠ¤åŒº)
                const dist = Math.abs(bx - snake[0].x) + Math.abs(by - snake[0].y);
                
                if (!checkCollision(bx, by) && dist > 3 && (bx !== food.x || by !== food.y)) {
                    bombs.push({x: bx, y: by});
                    valid = true;
                }
                safety++;
            }
        }

        function checkCollision(x, y) {
            // æ’å¢™
            if (x < 0 || x >= COLS || y < 0 || y >= ROWS) return 'wall';
            // æ’è‡ªå·±
            for (let p of snake) {
                if (p.x === x && p.y === y) return 'body';
            }
            // æ’ç‚¸å¼¹
            for (let b of bombs) {
                if (b.x === x && b.y === y) return 'bomb';
            }
            return false;
        }

        function update() {
            dx = nextDx;
            dy = nextDy;

            const head = {x: snake[0].x + dx, y: snake[0].y + dy};
            
            const colType = checkCollision(head.x, head.y);
            if (colType === 'wall') return gameOver("æ’åˆ°å¢™å£äº†!");
            if (colType === 'body') return gameOver("å’¬åˆ°è‡ªå·±äº†!");
            if (colType === 'bomb') return gameOver("BOOM! ç‚¸å¼¹çˆ†ç‚¸!");

            snake.unshift(head);

            // åƒé£Ÿç‰©
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                scoreEl.innerText = score;
                currentSpeed -= 2;
                spawnFood();
            } else {
                snake.pop();
            }

            // draw ä¼šè¢«æ¸²æŸ“å¾ªç¯æŒç»­è°ƒç”¨ï¼Œä½†åœ¨è¿™é‡Œä¿ç•™ä¸€æ¬¡ç»˜åˆ¶ä»¥ä¿è¯ç«‹å³åˆ·æ–°
            draw();
        }

        // æŒç»­æ¸²æŸ“å¾ªç¯ï¼šä¸é€»è¾‘æ›´æ–°ï¼ˆsetIntervalï¼‰è§£è€¦ï¼Œä¿è¯ç”»é¢å³æ—¶åé¦ˆ
        function loopRender() {
            if (!isRunning) return; // åœæ­¢æ¸²æŸ“
            draw();
            requestAnimationFrame(loopRender);
        }

        function startRender() {
            requestAnimationFrame(loopRender);
        }

        function draw() {
            // èƒŒæ™¯
            ctx.fillStyle = COLOR_GAME_BG;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç½‘æ ¼çº¿ (ç¨å¾®æš—æ·¡ä¸€ç‚¹)
            ctx.strokeStyle = COLOR_GRID;
            ctx.lineWidth = 1;
            ctx.beginPath();
            // åªç”»å‡ æ¡çº¿æ„æ€ä¸€ä¸‹ï¼Œç”»å¤ªå¯†å½±å“æ€§èƒ½å’Œè§†è§‰
            // è¿™é‡Œé€‰æ‹©ç”»å®Œæ•´çš„ç½‘æ ¼
            for(let i=0; i<=COLS; i++) { ctx.moveTo(i*GRID_SIZE,0); ctx.lineTo(i*GRID_SIZE, canvas.height); }
            for(let j=0; j<=ROWS; j++) { ctx.moveTo(0, j*GRID_SIZE); ctx.lineTo(canvas.width, j*GRID_SIZE); }
            ctx.stroke();

            // é£Ÿç‰©
            ctx.font = `${GRID_SIZE-2}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(food.icon, food.x*GRID_SIZE + GRID_SIZE/2, food.y*GRID_SIZE + GRID_SIZE/2 + 2);

            // ç‚¸å¼¹
            for(let b of bombs) {
                ctx.fillText('ğŸ’£', b.x*GRID_SIZE + GRID_SIZE/2, b.y*GRID_SIZE + GRID_SIZE/2 + 2);
            }

            // è›‡
            snake.forEach((p, i) => {
                if (i === 0) ctx.fillStyle = COLOR_SNAKE_HEAD; // å¤´
                else ctx.fillStyle = COLOR_SNAKE_BODY; // èº«

                ctx.fillRect(p.x*GRID_SIZE+1, p.y*GRID_SIZE+1, GRID_SIZE-2, GRID_SIZE-2);
            });
        }

        function drawStatic() {
            ctx.fillStyle = COLOR_GAME_BG;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = COLOR_MUTED;
            ctx.font = '20px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText("è¯·ç‚¹å‡»å¼€å§‹", canvas.width/2, canvas.height/2);
        }

        // --- æ§åˆ¶ ---
        function setDir(d) {
            if (!isRunning) return;
            // ä½¿ç”¨ nextDx/nextDy åš 180 åº¦ç¿»è½¬æ ¡éªŒï¼Œè¿™æ ·å¯ä»¥åœ¨ä¸€æ¬¡ç§»åŠ¨é—´éš”å†…ç¼“å­˜å¤šæ¬¡æŒ‰é”®
            if (d === 'up' && nextDy === 0) { nextDx = 0; nextDy = -1; }
            if (d === 'down' && nextDy === 0) { nextDx = 0; nextDy = 1; }
            if (d === 'left' && nextDx === 0) { nextDx = -1; nextDy = 0; }
            if (d === 'right' && nextDx === 0) { nextDx = 1; nextDy = 0; }

            // ç«‹å³é‡ç»˜ï¼Œæä¾›æ›´åŠæ—¶çš„è§†è§‰åé¦ˆï¼ˆæ¸²æŸ“ä¸å†ä¾èµ–ç§»åŠ¨é—´éš”ï¼‰
            draw();
        }

        // é”®ç›˜
        document.addEventListener('keydown', e => {
            if ([37,38,39,40].includes(e.keyCode)) e.preventDefault();
            if (e.key === 'ArrowUp') setDir('up');
            if (e.key === 'ArrowDown') setDir('down');
            if (e.key === 'ArrowLeft') setDir('left');
            if (e.key === 'ArrowRight') setDir('right');
        });

        // è™šæ‹ŸæŒ‰é”®
        document.querySelectorAll('.key').forEach(btn => {
            // é˜²æ­¢é•¿æŒ‰é€‰ä¸­æ–‡æœ¬
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                setDir(btn.dataset.dir);
                btn.style.backgroundColor = 'rgba(255,255,255,0.3)';
            });
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                btn.style.backgroundColor = '';
            });
            // å…¼å®¹PCé¼ æ ‡
            btn.addEventListener('mousedown', () => setDir(btn.dataset.dir));
        });

    </script>
</body>
</html>